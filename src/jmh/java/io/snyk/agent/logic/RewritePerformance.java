package io.snyk.agent.logic;

import io.snyk.agent.jvm.LandingZone;
import io.snyk.agent.util.AsmUtil;
import io.snyk.agent.util.Log;
import io.snyk.asm.ClassReader;
import io.snyk.asm.tree.ClassNode;
import org.openjdk.jmh.annotations.*;

import java.util.Collections;
import java.util.concurrent.TimeUnit;

// notes:
//  * due to plugin bug, gradle must be run with --no-daemon or it will randomly fail to rebuild the code
//  * (it's still better than the jmh-by-hand situation)

@State(Scope.Thread)
@BenchmarkMode(Mode.AverageTime)
@OutputTimeUnit(TimeUnit.MICROSECONDS)
public class RewritePerformance {

    // this is "protected" by the @Scope annotation on the class,
    // don't fiddle with it.
    private byte[] classBlackHole = TEST_VICTIM;
    private ClassReader classReaderBlackHole = new ClassReader(classBlackHole);

    @Benchmark
    public String justLoadName() {
        return new ClassReader(classBlackHole).getClassName();
    }

    @Benchmark
    public ClassNode justParse() {
        return AsmUtil.parse(new ClassReader(classBlackHole));
    }

    @Benchmark
    public byte[] parseAndSave() {
        return AsmUtil.byteArray(AsmUtil.parse(new ClassReader(classBlackHole)));
    }

    @Benchmark
    public byte[] justRewrite() {
        return Rewriter.rewrite(
                ConfigTest.makeConfig(
                        Collections.singleton("projectId=ab95b1fb-4fe0-497d-aba0-5a1d85db0827"),
                        Collections.emptyList()),
                new NullLogger(),
                new Rewriter.CallbackTo(LandingZone.class,
                        LandingZone.SEEN_SET::add,
                        "13371337:tests", warning -> {}),
                classReaderBlackHole,
                Collections.emptyList()
        );
    }

    @Benchmark
    public byte[] loadBoth() {
        return Rewriter.rewrite(
                ConfigTest.makeConfig(
                        Collections.singleton("projectId=ab95b1fb-4fe0-497d-aba0-5a1d85db0827"),
                        Collections.emptyList()),
                new NullLogger(),
                new Rewriter.CallbackTo(LandingZone.class,
                        LandingZone.SEEN_SET::add,
                        "13371337:tests", warning -> {}),
                new ClassReader(classBlackHole),
                Collections.emptyList()
        );
    }


    // snapshotted here to avoid
    // a) dependencies, because the build system is total garbage, and
    // b) any rewriting by jmh
    // for (byte b : Files.readAllBytes(new File("./agent/build/classes/java/test/io/snyk/agent/logic/TestVictim.class")
    // .toPath())) { System.out.print(b); System.out.print(", "); } | fold -w 80 -s
    private static final byte[] TEST_VICTIM = new byte[]{
            -54, -2, -70, -66, 0, 0, 0, 52, 0, 98, 10, 0, 10, 0, 63, 18, 0, 0, 0, 69, 9, 0,
            9, 0, 70, 9, 0, 9, 0, 71, 10, 0, 9, 0, 72, 10, 0, 73, 0, 74, 10, 0, 9, 0, 75,
            8, 0, 76, 7, 0, 77, 7, 0, 78, 7, 0, 79, 1, 0, 8, 105, 110, 116, 70, 105, 101,
            108, 100, 1, 0, 1, 73, 1, 0, 11, 115, 116, 114, 105, 110, 103, 70, 105, 101,
            108, 100, 1, 0, 18, 76, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 83, 116,
            114, 105, 110, 103, 59, 1, 0, 6, 60, 105, 110, 105, 116, 62, 1, 0, 3, 40, 41,
            86, 1, 0, 4, 67, 111, 100, 101, 1, 0, 15, 76, 105, 110, 101, 78, 117, 109, 98,
            101, 114, 84, 97, 98, 108, 101, 1, 0, 18, 76, 111, 99, 97, 108, 86, 97, 114,
            105, 97, 98, 108, 101, 84, 97, 98, 108, 101, 1, 0, 4, 116, 104, 105, 115, 1, 0,
            32, 76, 105, 111, 47, 115, 110, 121, 107, 47, 97, 103, 101, 110, 116, 47, 108,
            111, 103, 105, 99, 47, 84, 101, 115, 116, 86, 105, 99, 116, 105, 109, 59, 1, 0,
            10, 114, 101, 116, 117, 114, 110, 70, 105, 118, 101, 1, 0, 3, 40, 41, 73, 1, 0,
            11, 101, 109, 112, 116, 121, 77, 101, 116, 104, 111, 100, 1, 0, 3, 98, 97, 114,
            1, 0, 12, 108, 111, 99, 97, 108, 71, 101, 110, 101, 114, 105, 99, 1, 0, 38, 40,
            76, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 79, 98, 106, 101, 99, 116, 59,
            41, 76, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 79, 98, 106, 101, 99, 116,
            59, 1, 0, 1, 116, 1, 0, 18, 76, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47,
            79, 98, 106, 101, 99, 116, 59, 1, 0, 22, 76, 111, 99, 97, 108, 86, 97, 114,
            105, 97, 98, 108, 101, 84, 121, 112, 101, 84, 97, 98, 108, 101, 1, 0, 3, 84,
            84, 59, 1, 0, 9, 83, 105, 103, 110, 97, 116, 117, 114, 101, 1, 0, 30, 60, 84,
            58, 76, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 79, 98, 106, 101, 99, 116,
            59, 62, 40, 84, 84, 59, 41, 84, 84, 59, 1, 0, 12, 114, 101, 116, 117, 114, 110,
            76, 97, 109, 98, 100, 97, 1, 0, 33, 40, 41, 76, 106, 97, 118, 97, 47, 117, 116,
            105, 108, 47, 99, 111, 110, 99, 117, 114, 114, 101, 110, 116, 47, 67, 97, 108,
            108, 97, 98, 108, 101, 59, 1, 0, 53, 40, 41, 76, 106, 97, 118, 97, 47, 117,
            116, 105, 108, 47, 99, 111, 110, 99, 117, 114, 114, 101, 110, 116, 47, 67, 97,
            108, 108, 97, 98, 108, 101, 60, 76, 106, 97, 118, 97, 47, 108, 97, 110, 103,
            47, 83, 116, 114, 105, 110, 103, 59, 62, 59, 1, 0, 11, 103, 101, 116, 73, 110,
            116, 70, 105, 101, 108, 100, 1, 0, 11, 115, 101, 116, 73, 110, 116, 70, 105,
            101, 108, 100, 1, 0, 4, 40, 73, 41, 86, 1, 0, 2, 116, 111, 1, 0, 14, 103, 101,
            116, 83, 116, 114, 105, 110, 103, 70, 105, 101, 108, 100, 1, 0, 20, 40, 41, 76,
            106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 83, 116, 114, 105, 110, 103, 59,
            1, 0, 14, 115, 101, 116, 83, 116, 114, 105, 110, 103, 70, 105, 101, 108, 100,
            1, 0, 21, 40, 76, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 83, 116, 114,
            105, 110, 103, 59, 41, 86, 1, 0, 9, 100, 111, 78, 111, 116, 104, 105, 110, 103,
            1, 0, 4, 119, 105, 116, 104, 1, 0, 7, 115, 119, 105, 116, 99, 104, 49, 1, 0, 4,
            40, 73, 41, 73, 1, 0, 3, 114, 101, 116, 1, 0, 5, 105, 110, 112, 117, 116, 1, 0,
            13, 83, 116, 97, 99, 107, 77, 97, 112, 84, 97, 98, 108, 101, 1, 0, 7, 115, 119,
            105, 116, 99, 104, 50, 1, 0, 4, 99, 97, 108, 108, 1, 0, 20, 40, 41, 76, 106,
            97, 118, 97, 47, 108, 97, 110, 103, 47, 78, 117, 109, 98, 101, 114, 59, 1, 0,
            10, 69, 120, 99, 101, 112, 116, 105, 111, 110, 115, 7, 0, 80, 1, 0, 20, 40, 41,
            76, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 79, 98, 106, 101, 99, 116, 59,
            1, 0, 21, 108, 97, 109, 98, 100, 97, 36, 114, 101, 116, 117, 114, 110, 76, 97,
            109, 98, 100, 97, 36, 48, 1, 0, 69, 76, 106, 97, 118, 97, 47, 108, 97, 110,
            103, 47, 79, 98, 106, 101, 99, 116, 59, 76, 106, 97, 118, 97, 47, 117, 116,
            105, 108, 47, 99, 111, 110, 99, 117, 114, 114, 101, 110, 116, 47, 67, 97, 108,
            108, 97, 98, 108, 101, 60, 76, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 78,
            117, 109, 98, 101, 114, 59, 62, 59, 1, 0, 10, 83, 111, 117, 114, 99, 101, 70,
            105, 108, 101, 1, 0, 15, 84, 101, 115, 116, 86, 105, 99, 116, 105, 109, 46,
            106, 97, 118, 97, 12, 0, 16, 0, 17, 1, 0, 16, 66, 111, 111, 116, 115, 116, 114,
            97, 112, 77, 101, 116, 104, 111, 100, 115, 15, 6, 0, 81, 16, 0, 58, 15, 6, 0,
            82, 16, 0, 43, 12, 0, 54, 0, 36, 12, 0, 12, 0, 13, 12, 0, 14, 0, 15, 12, 0, 46,
            0, 40, 7, 0, 83, 12, 0, 84, 0, 85, 12, 0, 54, 0, 55, 1, 0, 11, 104, 101, 108,
            108, 111, 32, 119, 111, 114, 108, 100, 1, 0, 30, 105, 111, 47, 115, 110, 121,
            107, 47, 97, 103, 101, 110, 116, 47, 108, 111, 103, 105, 99, 47, 84, 101, 115,
            116, 86, 105, 99, 116, 105, 109, 1, 0, 16, 106, 97, 118, 97, 47, 108, 97, 110,
            103, 47, 79, 98, 106, 101, 99, 116, 1, 0, 29, 106, 97, 118, 97, 47, 117, 116,
            105, 108, 47, 99, 111, 110, 99, 117, 114, 114, 101, 110, 116, 47, 67, 97, 108,
            108, 97, 98, 108, 101, 1, 0, 19, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47,
            69, 120, 99, 101, 112, 116, 105, 111, 110, 10, 0, 86, 0, 87, 10, 0, 9, 0, 88,
            1, 0, 17, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 73, 110, 116, 101, 103,
            101, 114, 1, 0, 7, 118, 97, 108, 117, 101, 79, 102, 1, 0, 22, 40, 73, 41, 76,
            106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 73, 110, 116, 101, 103, 101, 114,
            59, 7, 0, 89, 12, 0, 90, 0, 94, 12, 0, 59, 0, 43, 1, 0, 34, 106, 97, 118, 97,
            47, 108, 97, 110, 103, 47, 105, 110, 118, 111, 107, 101, 47, 76, 97, 109, 98,
            100, 97, 77, 101, 116, 97, 102, 97, 99, 116, 111, 114, 121, 1, 0, 11, 109, 101,
            116, 97, 102, 97, 99, 116, 111, 114, 121, 7, 0, 96, 1, 0, 6, 76, 111, 111, 107,
            117, 112, 1, 0, 12, 73, 110, 110, 101, 114, 67, 108, 97, 115, 115, 101, 115, 1,
            0, -52, 40, 76, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 105, 110, 118,
            111, 107, 101, 47, 77, 101, 116, 104, 111, 100, 72, 97, 110, 100, 108, 101,
            115, 36, 76, 111, 111, 107, 117, 112, 59, 76, 106, 97, 118, 97, 47, 108, 97,
            110, 103, 47, 83, 116, 114, 105, 110, 103, 59, 76, 106, 97, 118, 97, 47, 108,
            97, 110, 103, 47, 105, 110, 118, 111, 107, 101, 47, 77, 101, 116, 104, 111,
            100, 84, 121, 112, 101, 59, 76, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47,
            105, 110, 118, 111, 107, 101, 47, 77, 101, 116, 104, 111, 100, 84, 121, 112,
            101, 59, 76, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 105, 110, 118, 111,
            107, 101, 47, 77, 101, 116, 104, 111, 100, 72, 97, 110, 100, 108, 101, 59, 76,
            106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 105, 110, 118, 111, 107, 101, 47,
            77, 101, 116, 104, 111, 100, 84, 121, 112, 101, 59, 41, 76, 106, 97, 118, 97,
            47, 108, 97, 110, 103, 47, 105, 110, 118, 111, 107, 101, 47, 67, 97, 108, 108,
            83, 105, 116, 101, 59, 7, 0, 97, 1, 0, 37, 106, 97, 118, 97, 47, 108, 97, 110,
            103, 47, 105, 110, 118, 111, 107, 101, 47, 77, 101, 116, 104, 111, 100, 72, 97,
            110, 100, 108, 101, 115, 36, 76, 111, 111, 107, 117, 112, 1, 0, 30, 106, 97,
            118, 97, 47, 108, 97, 110, 103, 47, 105, 110, 118, 111, 107, 101, 47, 77, 101,
            116, 104, 111, 100, 72, 97, 110, 100, 108, 101, 115, 0, 33, 0, 9, 0, 10, 0, 1,
            0, 11, 0, 2, 0, 0, 0, 12, 0, 13, 0, 0, 0, 0, 0, 14, 0, 15, 0, 0, 0, 16, 0, 1,
            0, 16, 0, 17, 0, 1, 0, 18, 0, 0, 0, 47, 0, 1, 0, 1, 0, 0, 0, 5, 42, -73, 0, 1,
            -79, 0, 0, 0, 2, 0, 19, 0, 0, 0, 6, 0, 1, 0, 0, 0, 8, 0, 20, 0, 0, 0, 12, 0, 1,
            0, 0, 0, 5, 0, 21, 0, 22, 0, 0, 0, 1, 0, 23, 0, 24, 0, 1, 0, 18, 0, 0, 0, 44,
            0, 1, 0, 1, 0, 0, 0, 2, 8, -84, 0, 0, 0, 2, 0, 19, 0, 0, 0, 6, 0, 1, 0, 0, 0,
            10, 0, 20, 0, 0, 0, 12, 0, 1, 0, 0, 0, 2, 0, 21, 0, 22, 0, 0, 0, 1, 0, 25, 0,
            17, 0, 1, 0, 18, 0, 0, 0, 43, 0, 0, 0, 1, 0, 0, 0, 1, -79, 0, 0, 0, 2, 0, 19,
            0, 0, 0, 6, 0, 1, 0, 0, 0, 14, 0, 20, 0, 0, 0, 12, 0, 1, 0, 0, 0, 1, 0, 21, 0,
            22, 0, 0, 1, 1, 0, 26, 0, 17, 0, 0, 0, 1, 0, 27, 0, 28, 0, 2, 0, 18, 0, 0, 0,
            72, 0, 1, 0, 2, 0, 0, 0, 2, 43, -80, 0, 0, 0, 3, 0, 19, 0, 0, 0, 6, 0, 1, 0, 0,
            0, 21, 0, 20, 0, 0, 0, 22, 0, 2, 0, 0, 0, 2, 0, 21, 0, 22, 0, 0, 0, 0, 0, 2, 0,
            29, 0, 30, 0, 1, 0, 31, 0, 0, 0, 12, 0, 1, 0, 0, 0, 2, 0, 29, 0, 32, 0, 1, 0,
            33, 0, 0, 0, 2, 0, 34, 0, 1, 0, 35, 0, 36, 0, 2, 0, 18, 0, 0, 0, 48, 0, 1, 0,
            1, 0, 0, 0, 6, -70, 0, 2, 0, 0, -80, 0, 0, 0, 2, 0, 19, 0, 0, 0, 6, 0, 1, 0, 0,
            0, 25, 0, 20, 0, 0, 0, 12, 0, 1, 0, 0, 0, 6, 0, 21, 0, 22, 0, 0, 0, 33, 0, 0,
            0, 2, 0, 37, 0, 0, 0, 38, 0, 24, 0, 1, 0, 18, 0, 0, 0, 47, 0, 1, 0, 1, 0, 0, 0,
            5, 42, -76, 0, 3, -84, 0, 0, 0, 2, 0, 19, 0, 0, 0, 6, 0, 1, 0, 0, 0, 31, 0, 20,
            0, 0, 0, 12, 0, 1, 0, 0, 0, 5, 0, 21, 0, 22, 0, 0, 0, 0, 0, 39, 0, 40, 0, 1, 0,
            18, 0, 0, 0, 62, 0, 2, 0, 2, 0, 0, 0, 6, 42, 27, -75, 0, 3, -79, 0, 0, 0, 2, 0,
            19, 0, 0, 0, 10, 0, 2, 0, 0, 0, 35, 0, 5, 0, 36, 0, 20, 0, 0, 0, 22, 0, 2, 0,
            0, 0, 6, 0, 21, 0, 22, 0, 0, 0, 0, 0, 6, 0, 41, 0, 13, 0, 1, 0, 0, 0, 42, 0,
            43, 0, 1, 0, 18, 0, 0, 0, 47, 0, 1, 0, 1, 0, 0, 0, 5, 42, -76, 0, 4, -80, 0, 0,
            0, 2, 0, 19, 0, 0, 0, 6, 0, 1, 0, 0, 0, 41, 0, 20, 0, 0, 0, 12, 0, 1, 0, 0, 0,
            5, 0, 21, 0, 22, 0, 0, 0, 0, 0, 44, 0, 45, 0, 1, 0, 18, 0, 0, 0, 62, 0, 2, 0,
            2, 0, 0, 0, 6, 42, 43, -75, 0, 4, -79, 0, 0, 0, 2, 0, 19, 0, 0, 0, 10, 0, 2, 0,
            0, 0, 45, 0, 5, 0, 46, 0, 20, 0, 0, 0, 22, 0, 2, 0, 0, 0, 6, 0, 21, 0, 22, 0,
            0, 0, 0, 0, 6, 0, 41, 0, 15, 0, 1, 0, 0, 0, 46, 0, 40, 0, 1, 0, 18, 0, 0, 0,
            53, 0, 0, 0, 2, 0, 0, 0, 1, -79, 0, 0, 0, 2, 0, 19, 0, 0, 0, 6, 0, 1, 0, 0, 0,
            50, 0, 20, 0, 0, 0, 22, 0, 2, 0, 0, 0, 1, 0, 21, 0, 22, 0, 0, 0, 0, 0, 1, 0,
            47, 0, 13, 0, 1, 0, 0, 0, 48, 0, 49, 0, 1, 0, 18, 0, 0, 0, -71, 0, 2, 0, 3, 0,
            0, 0, 56, 27, -85, 0, 0, 0, 0, 0, 45, 0, 0, 0, 2, 0, 0, 0, 1, 0, 0, 0, 27, 0,
            0, 0, 2, 0, 0, 0, 34, 8, 61, 42, 28, -74, 0, 5, 16, 6, 61, 42, 28, -74, 0, 5,
            -89, 0, 11, 16, 7, 61, 42, 28, -74, 0, 5, 28, -84, 0, 0, 0, 3, 0, 19, 0, 0, 0,
            38, 0, 9, 0, 0, 0, 54, 0, 28, 0, 56, 0, 30, 0, 57, 0, 35, 0, 60, 0, 38, 0, 61,
            0, 43, 0, 62, 0, 46, 0, 64, 0, 49, 0, 65, 0, 54, 0, 68, 0, 20, 0, 0, 0, 52, 0,
            5, 0, 30, 0, 5, 0, 50, 0, 13, 0, 2, 0, 38, 0, 8, 0, 50, 0, 13, 0, 2, 0, 0, 0,
            56, 0, 21, 0, 22, 0, 0, 0, 0, 0, 56, 0, 51, 0, 13, 0, 1, 0, 49, 0, 7, 0, 50, 0,
            13, 0, 2, 0, 52, 0, 0, 0, 9, 0, 4, 28, 6, 10, -4, 0, 7, 1, 0, 0, 0, 53, 0, 49,
            0, 1, 0, 18, 0, 0, 0, -64, 0, 2, 0, 3, 0, 0, 0, 59, 27, -85, 0, 0, 0, 0, 0, 48,
            0, 0, 0, 2, 0, 0, 0, 1, 0, 0, 0, 27, 0, 0, 0, 2, 0, 0, 0, 37, 8, 61, 42, 28,
            -74, 0, 5, -89, 0, 22, 16, 6, 61, 42, 28, -74, 0, 5, -89, 0, 11, 16, 7, 61, 42,
            28, -74, 0, 5, 28, -84, 0, 0, 0, 3, 0, 19, 0, 0, 0, 42, 0, 10, 0, 0, 0, 73, 0,
            28, 0, 75, 0, 30, 0, 76, 0, 35, 0, 77, 0, 38, 0, 79, 0, 41, 0, 80, 0, 46, 0,
            81, 0, 49, 0, 83, 0, 52, 0, 84, 0, 57, 0, 87, 0, 20, 0, 0, 0, 52, 0, 5, 0, 30,
            0, 8, 0, 50, 0, 13, 0, 2, 0, 41, 0, 8, 0, 50, 0, 13, 0, 2, 0, 0, 0, 59, 0, 21,
            0, 22, 0, 0, 0, 0, 0, 59, 0, 51, 0, 13, 0, 1, 0, 52, 0, 7, 0, 50, 0, 13, 0, 2,
            0, 52, 0, 0, 0, 9, 0, 4, 28, 9, 10, -4, 0, 7, 1, 0, 1, 0, 54, 0, 55, 0, 2, 0,
            18, 0, 0, 0, 48, 0, 1, 0, 1, 0, 0, 0, 6, 16, 17, -72, 0, 6, -80, 0, 0, 0, 2, 0,
            19, 0, 0, 0, 6, 0, 1, 0, 0, 0, 92, 0, 20, 0, 0, 0, 12, 0, 1, 0, 0, 0, 6, 0, 21,
            0, 22, 0, 0, 0, 56, 0, 0, 0, 4, 0, 1, 0, 57, 16, 65, 0, 54, 0, 58, 0, 2, 0, 18,
            0, 0, 0, 47, 0, 1, 0, 1, 0, 0, 0, 5, 42, -74, 0, 7, -80, 0, 0, 0, 2, 0, 19, 0,
            0, 0, 6, 0, 1, 0, 0, 0, 8, 0, 20, 0, 0, 0, 12, 0, 1, 0, 0, 0, 5, 0, 21, 0, 22,
            0, 0, 0, 56, 0, 0, 0, 4, 0, 1, 0, 57, 16, 10, 0, 59, 0, 43, 0, 2, 0, 18, 0, 0,
            0, 27, 0, 1, 0, 0, 0, 0, 0, 3, 18, 8, -80, 0, 0, 0, 1, 0, 19, 0, 0, 0, 6, 0, 1,
            0, 0, 0, 25, 0, 56, 0, 0, 0, 4, 0, 1, 0, 57, 0, 4, 0, 33, 0, 0, 0, 2, 0, 60, 0,
            61, 0, 0, 0, 2, 0, 62, 0, 93, 0, 0, 0, 10, 0, 1, 0, 91, 0, 95, 0, 92, 0, 25, 0,
            64, 0, 0, 0, 12, 0, 1, 0, 65, 0, 3, 0, 66, 0, 67, 0, 68,
    };
}

class NullLogger implements Log {
    @Override
    public void debug(String msg) {
    }

    @Override
    public void info(String msg) {
    }

    @Override
    public void warn(String msg) {
    }

    @Override
    public void stackTrace(Throwable e) {
    }

    @Override
    public void flushInitMessage(String initMessage) {
    }
}
